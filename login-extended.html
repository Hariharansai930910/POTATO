<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SliceMate Login üçï</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Basic styling -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fefaf0;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 400px;
      margin: 40px auto;
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      margin-left: 10px;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .tab {
      padding: 10px 15px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 14px;
    }
    .tab.active {
      border-bottom: 2px solid #ff6b00;
      font-weight: bold;
      color: #ff6b00;
    }
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .password-container {
      position: relative;
    }
    .toggle-password {
      position: absolute;
      right: 10px;
      top: 10px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    .checkbox-container input {
      margin-right: 8px;
    }
    .forgot-password {
      font-size: 13px;
      text-align: right;
      margin-top: 5px;
    }
    .forgot-password a {
      color: #ff6b00;
      text-decoration: none;
    }
    button[type="submit"] {
      background-color: #ff6b00;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin-top: 10px;
    }
    button[type="submit"]:hover {
      background-color: #e85f00;
    }
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
    }
    .error {
      background-color: #ffeded;
      border: 1px solid #ffd0d0;
      color: #d83030;
    }
    .success {
      background-color: #edfff5;
      border: 1px solid #d0ffd9;
      color: #30d867;
    }
    .loader {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ff6b00;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .button-content {
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span style="font-size: 28px;">üçï</span>
      <div class="logo">SliceMate</div>
    </div>
    
    <div class="tabs">
      <button class="tab active" id="login-tab">Login</button>
      <button class="tab" id="signup-tab">Sign Up</button>
    </div>
    
    <!-- Login Form -->
    <div class="form-section active" id="login-section">
      <form id="login-form">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" required>
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <div class="password-container">
            <input type="password" id="login-password" required>
            <button type="button" class="toggle-password" id="toggle-login-password">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="remember-me">
          <label for="remember-me" style="display: inline;">Remember me</label>
        </div>
        <div class="forgot-password">
          <a href="#" id="forgot-password-link">Forgot password?</a>
        </div>
        <div id="login-error" class="message error"></div>
        <div id="login-success" class="message success"></div>
        <button type="submit">
          <div class="button-content">
            <span>Login</span>
            <div class="loader" id="login-loader"></div>
          </div>
        </button>
      </form>
    </div>
    
    <!-- Sign Up Form -->
    <div class="form-section" id="signup-section">
      <form id="signup-form">
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" required>
        </div>
        <div class="form-group">
          <label for="signup-password">Password</label>
          <div class="password-container">
            <input type="password" id="signup-password" required>
            <button type="button" class="toggle-password" id="toggle-signup-password">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="form-group">
          <label for="confirm-password">Confirm Password</label>
          <input type="password" id="confirm-password" required>
        </div>
        <div id="signup-error" class="message error"></div>
        <div id="signup-success" class="message success"></div>
        <button type="submit">
          <div class="button-content">
            <span>Sign Up</span>
            <div class="loader" id="signup-loader"></div>
          </div>
        </button>
      </form>
    </div>
    
    <!-- Reset Password Form -->
    <div class="form-section" id="reset-section">
      <h3>Reset Password</h3>
      <p>Enter your email address and we'll send you a link to reset your password.</p>
      <form id="reset-form">
        <div class="form-group">
          <label for="reset-email">Email</label>
          <input type="email" id="reset-email" required>
        </div>
        <div id="reset-error" class="message error"></div>
        <div id="reset-success" class="message success"></div>
        <button type="submit">
          <div class="button-content">
            <span>Send Reset Link</span>
            <div class="loader" id="reset-loader"></div>
          </div>
        </button>
        <button type="button" id="back-to-login" style="background-color: #f0f0f0; color: #333; margin-top: 10px;">
          Back to Login
        </button>
      </form>
    </div>
  </div>

  <script>
    // Wait for the Firebase SDK to load
    document.addEventListener('DOMContentLoaded', function() {
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD7Qozb-m-XTHx3tXWVGI5ObgLN6TwmSKc",
        authDomain: "shrmte.firebaseapp.com",
        projectId: "shrmte",
        storageBucket: "shrmte.appspot.com",
        messagingSenderId: "660245185229",
        appId: "1:660245185229:web:d9fa02e30892bad9fd5f84"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      
      console.log("Firebase initialized successfully");
      
      // Set persistence to LOCAL by default (remember user between sessions)
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      
      // Check if user is already logged in
      auth.onAuthStateChanged(user => {
        if (user) {
          // User is already signed in, update status and redirect
          console.log('User already logged in:', user.email);
          updateUserStatus(user)
            .then(() => {
              showSuccessMessage('login-success', 'You are already logged in! Redirecting...');
              setTimeout(() => {
                window.location.href = 'index.html';
              }, 1500);
            })
            .catch(error => {
              console.error('Error updating user status:', error);
            });
        }
      });
      
      // Update user status in Firestore
      async function updateUserStatus(user) {
        try {
          await db.collection('users_nearby').doc(user.uid).set({
            email: user.email,
            available_to_match: true,
            last_seen: new Date().toISOString()
          }, { merge: true });
          console.log('User status updated successfully');
          return true;
        } catch (error) {
          console.error('Error updating user status:', error);
          throw error;
        }
      }
      
      // Tab switching functionality
      document.getElementById('login-tab').addEventListener('click', function() {
        showTab('login');
      });
      
      document.getElementById('signup-tab').addEventListener('click', function() {
        showTab('signup');
      });
      
      document.getElementById('forgot-password-link').addEventListener('click', function(e) {
        e.preventDefault();
        showTab('reset');
        
        // Copy email from login form if available
        const loginEmail = document.getElementById('login-email').value;
        if (loginEmail) {
          document.getElementById('reset-email').value = loginEmail;
        }
      });
      
      document.getElementById('back-to-login').addEventListener('click', function() {
        showTab('login');
      });
      
      function showTab(tabName) {
        // Reset all tabs and sections
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        document.querySelectorAll('.form-section').forEach(section => {
          section.classList.remove('active');
        });
        
        // Activate the selected tab and section
        if (tabName === 'login') {
          document.getElementById('login-tab').classList.add('active');
          document.getElementById('login-section').classList.add('active');
        } else if (tabName === 'signup') {
          document.getElementById('signup-tab').classList.add('active');
          document.getElementById('signup-section').classList.add('active');
        } else if (tabName === 'reset') {
          document.getElementById('reset-section').classList.add('active');
        }
        
        // Clear all error and success messages
        clearMessages();
      }
      
      // Toggle password visibility
      document.getElementById('toggle-login-password').addEventListener('click', function() {
        togglePasswordVisibility('login-password');
      });
      
      document.getElementById('toggle-signup-password').addEventListener('click', function() {
        togglePasswordVisibility('signup-password');
      });
      
      function togglePasswordVisibility(inputId) {
        const passwordInput = document.getElementById(inputId);
        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
      }
      
      // Login form submission
      document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        clearMessages();
        
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const rememberMe = document.getElementById('remember-me').checked;
        
        // Show loader
        document.getElementById('login-loader').style.display = 'inline-block';
        
        try {
          // Set persistence based on "Remember me" checkbox
          const persistence = rememberMe ? 
            firebase.auth.Auth.Persistence.LOCAL : 
            firebase.auth.Auth.Persistence.SESSION;
          
          await auth.setPersistence(persistence);
          
          // Sign in
          const userCred = await auth.signInWithEmailAndPassword(email, password);
          console.log('Logged in successfully:', userCred.user.email);
          
          // Update user status
          await updateUserStatus(userCred.user);
          
          // Show success message
          showSuccessMessage('login-success', 'Login successful! Redirecting...');
          
          // Redirect to main page after a short delay
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1500);
          
        } catch (err) {
          console.error('Login error:', err.code, err.message);
          
          // Handle different error types
          switch (err.code) {
            case 'auth/user-not-found':
              showErrorMessage('login-error', 'Account not found. Please sign up first.');
              break;
            case 'auth/wrong-password':
              showErrorMessage('login-error', 'Incorrect password. Please try again.');
              break;
            case 'auth/too-many-requests':
              showErrorMessage('login-error', 'Too many failed attempts. Please try again later.');
              break;
            case 'auth/user-disabled':
              showErrorMessage('login-error', 'This account has been disabled. Please contact support.');
              break;
            case 'auth/invalid-email':
              showErrorMessage('login-error', 'Invalid email format. Please check your email.');
              break;
            default:
              showErrorMessage('login-error', `Error: ${err.message}`);
          }
          
          // Hide loader
          document.getElementById('login-loader').style.display = 'none';
        }
      });
      
      // Signup form submission
      document.getElementById('signup-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        clearMessages();
        
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value.trim();
        const confirmPassword = document.getElementById('confirm-password').value.trim();
        
        // Validate passwords match
        if (password !== confirmPassword) {
          showErrorMessage('signup-error', 'Passwords do not match. Please try again.');
          return;
        }
        
        // Show loader
        document.getElementById('signup-loader').style.display = 'inline-block';
        
        try {
          // Create new user
          const userCred = await auth.createUserWithEmailAndPassword(email, password);
          console.log('New user signed up:', userCred.user.email);
          
          // Create user record in Firestore
          await db.collection('users_nearby').doc(userCred.user.uid).set({
            email: email,
            available_to_match: true,
            last_seen: new Date().toISOString()
          });
          
          // Show success message
          showSuccessMessage('signup-success', 'Account created successfully! Redirecting...');
          
          // Redirect to main page after a short delay
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1500);
          
        } catch (err) {
          console.error('Signup error:', err.code, err.message);
          
          // Handle different error types
          switch (err.code) {
            case 'auth/email-already-in-use':
              showErrorMessage('signup-error', 'This email is already registered. Please login instead.');
              break;
            case 'auth/invalid-email':
              showErrorMessage('signup-error', 'Invalid email format. Please check your email.');
              break;
            case 'auth/weak-password':
              showErrorMessage('signup-error', 'Password is too weak. Please use at least 6 characters.');
              break;
            default:
              showErrorMessage('signup-error', `Error: ${err.message}`);
          }
          
          // Hide loader
          document.getElementById('signup-loader').style.display = 'none';
        }
      });
      
      // Reset password form submission
      document.getElementById('reset-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        clearMessages();
        
        const email = document.getElementById('reset-email').value.trim();
        
        // Show loader
        document.getElementById('reset-loader').style.display = 'inline-block';
        
        try {
          // Send password reset email
          await auth.sendPasswordResetEmail(email);
          console.log('Password reset email sent');
          
          // Show success message
          showSuccessMessage('reset-success', 'Password reset link sent! Check your email.');
          
          // Hide loader
          document.getElementById('reset-loader').style.display = 'none';
          
        } catch (err) {
          console.error('Reset password error:', err.code, err.message);
          
          // Handle different error types
          switch (err.code) {
            case 'auth/user-not-found':
              showErrorMessage('reset-error', 'No account found with this email address.');
              break;
            case 'auth/invalid-email':
              showErrorMessage('reset-error', 'Invalid email format. Please check your email.');
              break;
            default:
              showErrorMessage('reset-error', `Error: ${err.message}`);
          }
          
          // Hide loader
          document.getElementById('reset-loader').style.display = 'none';
        }
      });
      
      // Helper functions for messages
      function showErrorMessage(elementId, message) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.style.display = 'block';
      }
      
      function showSuccessMessage(elementId, message) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.style.display = 'block';
      }
      
      function clearMessages() {
        const messages = document.querySelectorAll('.message');
        messages.forEach(message => {
          message.style.display = 'none';
          message.textContent = '';
        });
      }
    });
  </script>
</body>
</html>
